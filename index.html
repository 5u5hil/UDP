<!Doctype html>
<html>
    <head>
        <title>UDP</title>
        <meta charset="utf-8">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1,width=device-width, height=device-height, target-densitydpi=device-dpi" />
    </head>
    <body>

        <form class="pure-form pure-form-aligned">
            <fieldset>
                <div class="pure-control-group">
                    <label for="name">IP</label>
                    <input id="ip" name="ip" type="text" value="192.168.0.101" placeholder="IP">
                </div>

                <div class="pure-control-group">
                    <label for="name">Port</label>
                    <input id="port" name="port" type="number" value="55056" placeholder="Port">
                </div>

                <div class="pure-control-group">
                    <label for="name">Send Message</label>
                    <input id="msg" name="msg" type="text" value="Hello World!" placeholder="Message">
                </div>

                <div class="pure-controls">
                    <button type="button" class="pure-button pure-button-primary" id="send">Send</button>
                </div>
            </fieldset>
        </form>

        <p>To Subscribe use this IP : <strong id="myip"></strong> <input type="number" id="rport" name="rport" value="1823" /></p>

        <ul id="log">
            <li><strong>Received Messages</strong></li>
        </ul>

        <p>SSID : <strong id="ssid"></strong></p>


        <script type="text/javascript" src="jquery.min.js"></script>
        <script type="text/javascript" src="cordova.js"></script>





        <script type="text/javascript">




            document.addEventListener('deviceready', function () {




                networkinterface.getIPAddress(function (ip) {

                    $("#myip").text(ip);
                });
                try {
                    WifiWizard.getCurrentSSID(function (ip) {
                        $("#ssid").text(ip);
                    }, function () {
                        alert("error");
                    });
                } catch (err) {

                    alert(err.message);

                }



                $("#send").click(function () {
                    var address = $("#ip").val();
                    var port = $("#port").val();
                    var data = str2ab($("#msg").val());
                    var rport = $("#rport").val();
                    var ip = $("#myip").text();

                    try {

                        chrome.sockets.udp.create({}, function (socketInfo) {
                            toast(socketInfo);
                            var socketId = socketInfo.socketId;

                            chrome.sockets.udp.send(socketId, data, address, port, function (sendInfo) {
                                if (sendInfo.resultCode < 0) {
                                    toast(chrome.runtime.lastError.message);
                                } else {
                                    toast(sendInfo);
                                }
                            });
alert(ip);
                            chrome.sockets.udp.bind(socketId, ip, rport, function (result) {
                                alert('chrome.socket.bind: result = ' + result.toString());
                            });





                        });
                    } catch (err) {

                        alert("Error-  " + err.message);

                    }
                });

            }, false);




            function str2ab(str) {
                var buf = new ArrayBuffer(str.length * 2); // 2 bytes for each char
                var bufView = new Uint16Array(buf);
                for (var i = 0, strLen = str.length; i < strLen; i++) {
                    bufView[i] = str.charCodeAt(i);
                }
                return buf;
            }

            function toast(m) {
                alert(JSON.stringify(m));
            }



        </script>
    </body>
</html>